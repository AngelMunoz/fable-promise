<html class="has-navbar-fixed-top"><head><title>Fable.Promise Â· Computation expression</title><meta http-equiv="content-type"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" type="text/css" href="/fable-promise/style.css"/><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous"/></head><body><nav class="navbar is-fixed-top"><div class="container"><div class="navbar-brand"><a class="navbar-item title is-4" href="https://fable.io/fable-promise/">Fable.Promise</a><a class="navbar-item is-hidden-desktop" href="https://github.com/fable-compiler/fable-promise"><span class="icon"><i class=" fab fa-github fa-lg"></i></span></a><a class="navbar-item is-hidden-desktop" href="https://twitter.com/FableCompiler"><span class="icon"><i class=" fab fa-twitter fa-lg"></i></span></a><a class="navbar-burger" data-target="nav-menu"><span></span><span></span><span></span></a></div><div class="navbar-menu" id="nav-menu"><div class="navbar-start"><a class="navbar-item is-active" href="/fable-promise/documentation/getting-started.html">Documentation</a></div><div class="navbar-end"><a class="navbar-item" href="https://github.com/fable-compiler/fable-promise"><span class="icon"><i class=" fab fa-github fa-lg"></i></span></a><a class="navbar-item" href="https://twitter.com/FableCompiler"><span class="icon"><i class=" fab fa-twitter fa-lg"></i></span></a></div></div></div></nav><div class="container"><div class="mobile-menu"><nav class="breadcrumb"><ul><li><a class="menu-trigger"><span></span><span></span><span></span></a></li><li class="is-active"><a>API</a></li><li class="is-active"><a>Computation expression</a></li></ul></nav></div><div class="columns is-gapless is-mobile"><div class="column is-menu-column is-3-desktop is-hidden-touch ml-5"><div class="menu-container"><aside class="menu"><ul class="menu-list"><li><a class=" " href="/fable-promise/documentation/getting-started.html">Getting started</a></li><ul class="menu-list"><p class="menu-label">API</p><li><a class=" " href="/fable-promise/documentation/pipeline.html">Pipeline</a></li><li><a class=" is-active has-table-of-content" href="/fable-promise/documentation/computation-expression.html">Computation expression</a></li><ul class="table-of-content"><li><a href="#Introduction" data-toc-element="true">Introduction </a></li><li><a href="#Guides" data-toc-element="true">Guides </a><ul class="table-of-content"><li><a href="#Create-a-promise" data-toc-element="true">Create a promise </a></li><li><a href="#Chaining-promises" data-toc-element="true">Chaining promises </a></li><li><a href="#Nesting-promises" data-toc-element="true">Nesting promises </a></li><li><a href="#Parallel" data-toc-element="true">Parallel </a></li><li><a href="#Support-non-native-promise-(aka-Thenable)" data-toc-element="true">Support non-native promise (aka Thenable) </a></li></ul></li></ul></ul></ul></aside></div></div><div class="column is-8-desktop is-full-touch"><section class="section"><div class="content"><header class="page-header"><a class="button is-hidden-touch is-outlined is-primary is-pulled-right" target="_blank" href="https://github.com/fable-compiler/fable-promise/edit/master/docsrc/documentation/computation-expression.md">Edit</a><h1 class="title is-1">Computation expression</h1></header><div><h2>Introduction <a href="#Introduction" aria-hidden="true"><span class="anchor" id="Introduction"></span>#</a></h2>
<p>The <code>promise</code> computation expression makes it really easy to create and compose promise using F#.</p>
<div class="columns" date-disable-copy-button="true">
    <div class="column is-half-desktop">
<div class="has-text-centered mb-2 has-text-weight-semibold">Pipeline API</div>
<pre style="background-color: #FFFFFF;color: #000000;padding: 1em"><code><span>fetch </span><span style="color: #50A14F">&quot;https://x.x/users&quot;</span>
<span style="color: #A626A4">|&gt;</span><span> Promise.map </span><span style="color: #A626A4">(fun</span><span style="color: #383A42"> response </span><span style="color: #A626A4">-&gt;</span>
<span>    fetch </span><span style="color: #50A14F">&quot;https://x.x/posts&quot;</span>
<span style="color: #A626A4">)</span>
<span style="color: #A626A4">|&gt;</span><span> Promise.map </span><span style="color: #A626A4">(fun</span><span style="color: #383A42"> response </span><span style="color: #A626A4">-&gt;</span>
<span>    </span><span style="color: #A0A1A7;font-style: italic">// Done, do something with the result</span>
<span style="color: #A626A4">)</span></code></pre>
</div>
    <div class="column is-half-desktop">
<div class="has-text-centered mb-2 has-text-weight-semibold">Computation expression</div>
<pre style="background-color: #FFFFFF;color: #000000;padding: 1em"><code><span style="color: #A626A4">promise {</span>
<span>    </span><span style="color: #A626A4">let!</span><span> </span><span style="color: #E45649">users</span><span> </span><span style="color: #A626A4">=</span><span> fetch </span><span style="color: #50A14F">&quot;https://x.x/users&quot;</span>
<span>    </span><span style="color: #A626A4">let!</span><span> </span><span style="color: #E45649">posts</span><span> </span><span style="color: #A626A4">=</span><span> fetch </span><span style="color: #50A14F">&quot;https://x.x/posts&quot;</span>

<span>    </span><span style="color: #A0A1A7;font-style: italic">// Done, do something with the result</span>
<span>    </span><span style="color: #A626A4">return</span><span> </span><span style="color: #A0A1A7;font-style: italic">//...</span>
<span style="color: #A626A4">}</span></code></pre>
</div>
</div>
<h2>Guides <a href="#Guides" aria-hidden="true"><span class="anchor" id="Guides"></span>#</a></h2>
<p>Here is a quick guides of what you can do with <code>promise</code> computations.</p>
<p>You can read more about computation expression in F# <a href="https://docs.microsoft.com/en-us/dotnet/fsharp/language-reference/computation-expressions">here</a>.</p>
<h3>Create a promise <a href="#Create-a-promise" aria-hidden="true"><span class="anchor" id="Create-a-promise"></span>#</a></h3>
<p>Creating a promise is as simple as writing <code>promise { }</code>.</p>
<pre style="background-color: #FFFFFF;color: #000000;padding: 1em"><code><span style="color: #A626A4">let</span><span> </span><span style="color: #E45649">double</span><span style="color: #383A42"> </span><span style="color: #A626A4">(</span><span style="color: #383A42">value </span><span style="color: #A626A4">:</span><span> </span><span style="color: #C18401">int</span><span style="color: #A626A4">)</span><span> </span><span style="color: #A626A4">=</span>
<span>    </span><span style="color: #A626A4">promise {</span>
<span>        </span><span style="color: #A626A4">return</span><span> value </span><span style="color: #A626A4">*</span><span> </span><span style="color: #986801">2</span>
<span>    </span><span style="color: #A626A4">}</span></code></pre>
<h3>Chaining promises <a href="#Chaining-promises" aria-hidden="true"><span class="anchor" id="Chaining-promises"></span>#</a></h3>
<p>If you need the result of a promise before calling another one, use the <code>let!</code> keyword</p>
<pre style="background-color: #FFFFFF;color: #000000;padding: 1em"><code><span style="color: #A626A4">promise {</span>
<span>    </span><span style="color: #A626A4">let!</span><span> </span><span style="color: #E45649">user</span><span> </span><span style="color: #A626A4">=</span><span> fetchUsers session</span>
<span>    </span><span style="color: #A626A4">let!</span><span> </span><span style="color: #E45649">permission</span><span> </span><span style="color: #A626A4">=</span><span> fetchPermission user</span>

<span>    </span><span style="color: #A626A4">return</span><span> permission</span>
<span style="color: #A626A4">}</span></code></pre>
<p>You can also directly return the result of a promise avoiding to use <code>let!</code> and <code>return</code></p>
<p><code>return!</code> will evaluate the promise and return the result value when completed</p>
<pre style="background-color: #FFFFFF;color: #000000;padding: 1em"><code><span style="color: #A626A4">promise {</span>
<span>    </span><span style="color: #A626A4">let!</span><span> </span><span style="color: #E45649">user</span><span> </span><span style="color: #A626A4">=</span><span> fetchUsers session</span>

<span>    </span><span style="color: #A626A4">return!</span><span> fetchPermission user</span>
<span style="color: #A626A4">}</span></code></pre>
<h3>Nesting promises <a href="#Nesting-promises" aria-hidden="true"><span class="anchor" id="Nesting-promises"></span>#</a></h3>
<p>You can nest <code>promise</code> computation as needed.</p>
<pre style="background-color: #FFFFFF;color: #000000;padding: 1em"><code><span style="color: #A626A4">promise {</span>
<span>    </span><span style="color: #A0A1A7;font-style: italic">// Nested promise which returns a value</span>
<span>    </span><span style="color: #A626A4">let!</span><span> </span><span style="color: #E45649">isValid</span><span> </span><span style="color: #A626A4">=</span>
<span>        </span><span style="color: #A626A4">promise {</span>
<span>            </span><span style="color: #A0A1A7;font-style: italic">// Do something</span>
<span>            </span><span style="color: #A626A4">return</span><span> aValue</span>
<span>        </span><span style="color: #A626A4">}</span>

<span>    </span><span style="color: #A0A1A7;font-style: italic">// Nested promise which return unit</span>
<span>    </span><span style="color: #A626A4">do!</span><span> </span><span style="color: #A626A4">promise {</span>
<span>        </span><span style="color: #A0A1A7;font-style: italic">// Do something</span>
<span>        </span><span style="color: #A626A4">return</span><span> </span><span style="color: #986801">()</span>
<span>    </span><span style="color: #A626A4">}</span>
<span style="color: #A626A4">}</span></code></pre>
<h3>Parallel <a href="#Parallel" aria-hidden="true"><span class="anchor" id="Parallel"></span>#</a></h3>
<p>If you have independent promise, you can use <code>let!</code> and <code>and!</code> to run them in parallel.</p>
<pre style="background-color: #FFFFFF;color: #000000;padding: 1em"><code><span style="color: #A626A4">let</span><span> </span><span style="color: #E45649">p1</span><span> </span><span style="color: #A626A4">=</span>
<span>    </span><span style="color: #A626A4">promise {</span>
<span>        </span><span style="color: #A626A4">do!</span><span> Promise.sleep </span><span style="color: #986801">100</span>
<span>        </span><span style="color: #A626A4">return</span><span> </span><span style="color: #986801">1</span>
<span>    </span><span style="color: #A626A4">}</span>
<span style="color: #A626A4">let</span><span> </span><span style="color: #E45649">p2</span><span> </span><span style="color: #A626A4">=</span>
<span>    </span><span style="color: #A626A4">promise {</span>
<span>        </span><span style="color: #A626A4">do!</span><span> Promise.sleep </span><span style="color: #986801">200</span>
<span>        </span><span style="color: #A626A4">return</span><span> </span><span style="color: #986801">2</span>
<span>    </span><span style="color: #A626A4">}</span>
<span style="color: #A626A4">let</span><span> </span><span style="color: #E45649">p3</span><span> </span><span style="color: #A626A4">=</span>
<span>    </span><span style="color: #A626A4">promise {</span>
<span>        </span><span style="color: #A626A4">do!</span><span> Promise.sleep </span><span style="color: #986801">300</span>
<span>        </span><span style="color: #A626A4">return</span><span> </span><span style="color: #986801">3</span>
<span>    </span><span style="color: #A626A4">}</span>

<span style="color: #A626A4">promise {</span>
<span>    </span><span style="color: #A626A4">let!</span><span> </span><span style="color: #E45649">a</span><span> </span><span style="color: #A626A4">=</span><span> p1</span>
<span>    </span><span style="color: #A626A4">and!</span><span> b </span><span style="color: #A626A4">=</span><span> p2</span>
<span>    </span><span style="color: #A626A4">and!</span><span> c </span><span style="color: #A626A4">=</span><span> p3</span>

<span>    </span><span style="color: #A626A4">return</span><span> a </span><span style="color: #A626A4">+</span><span> b </span><span style="color: #A626A4">+</span><span> c </span><span style="color: #A0A1A7;font-style: italic">// 1 + 2 + 3 = 6</span>
<span style="color: #A626A4">}</span></code></pre>
<h3>Support non-native promise (aka Thenable) <a href="#Support-non-native-promise-(aka-Thenable)" aria-hidden="true"><span class="anchor" id="Support-non-native-promise-(aka-Thenable)"></span>#</a></h3>
<p>In JavaScript, a thenable is an object that has a <code>then()</code> function. All promises are thenables, but not all thenables are promises.</p>
<p>For example, this is the case when working on a VSCode extensions, or with mongoose, axios.</p>
<p><a href="https://masteringjs.io/tutorials/fundamentals/thenable">Source</a></p>
<p>You can extends the <code>promise</code> extension to make it easy to works with your thenable.</p>
<p>Example:</p>
<pre style="background-color: #FFFFFF;color: #000000;padding: 1em"><code><span style="color: #A0A1A7;font-style: italic">/// This is the definition of a thenable from ts2fable&#039;s generation VsCode API</span>
<span style="color: #A626A4">type</span><span> </span><span style="color: #0184BC">[&lt;AllowNullLiteral&gt;]</span><span> </span><span style="color: #C18401">Thenable</span><span style="color: #A626A4">&lt;</span><span style="color: #C18401">&#039;T</span><span style="color: #A626A4">&gt;</span><span> </span><span style="color: #A626A4">=</span>
<span>    </span><span style="color: #A626A4">abstract</span><span> ``then``</span><span style="color: #A626A4">:</span><span> </span><span style="color: #A626A4">?</span><span style="color: #383A42">onfulfilled</span><span style="color: #A626A4">:</span><span> </span><span style="color: #A626A4">(</span><span>&#039;</span><span style="color: #C18401">T</span><span> </span><span style="color: #A626A4">-&gt;</span><span> </span><span style="color: #C18401">U2</span><span style="color: #A626A4">&lt;</span><span style="color: #C18401">&#039;TResult</span><span style="color: #A626A4">,</span><span style="color: #C18401"> Thenable</span><span style="color: #A626A4">&lt;</span><span style="color: #C18401">&#039;TResult</span><span style="color: #A626A4">&gt;&gt;)</span><span> </span><span style="color: #A626A4">*</span><span> </span><span style="color: #A626A4">?</span><span style="color: #383A42">onrejected</span><span style="color: #A626A4">:</span><span> </span><span style="color: #A626A4">(</span><span style="color: #C18401">obj</span><span> </span><span style="color: #C18401">option</span><span> </span><span style="color: #A626A4">-&gt;</span><span> </span><span style="color: #C18401">U2</span><span style="color: #A626A4">&lt;</span><span style="color: #C18401">&#039;TResult</span><span style="color: #A626A4">,</span><span style="color: #C18401"> Thenable</span><span style="color: #A626A4">&lt;</span><span style="color: #C18401">&#039;TResult</span><span style="color: #A626A4">&gt;&gt;)</span><span> </span><span style="color: #A626A4">-&gt;</span><span> </span><span style="color: #C18401">Thenable</span><span style="color: #A626A4">&lt;</span><span style="color: #C18401">&#039;TResult</span><span style="color: #A626A4">&gt;</span>
<span>    </span><span style="color: #A626A4">abstract</span><span> ``then``</span><span style="color: #A626A4">:</span><span> </span><span style="color: #A626A4">?</span><span style="color: #383A42">onfulfilled</span><span style="color: #A626A4">:</span><span> </span><span style="color: #A626A4">(</span><span>&#039;</span><span style="color: #C18401">T</span><span> </span><span style="color: #A626A4">-&gt;</span><span> </span><span style="color: #C18401">U2</span><span style="color: #A626A4">&lt;</span><span style="color: #C18401">&#039;TResult</span><span style="color: #A626A4">,</span><span style="color: #C18401"> Thenable</span><span style="color: #A626A4">&lt;</span><span style="color: #C18401">&#039;TResult</span><span style="color: #A626A4">&gt;&gt;)</span><span> </span><span style="color: #A626A4">*</span><span> </span><span style="color: #A626A4">?</span><span style="color: #383A42">onrejected</span><span style="color: #A626A4">:</span><span> </span><span style="color: #A626A4">(</span><span style="color: #C18401">obj</span><span> </span><span style="color: #C18401">option</span><span> </span><span style="color: #A626A4">-&gt;</span><span> </span><span style="color: #C18401">unit</span><span style="color: #A626A4">)</span><span> </span><span style="color: #A626A4">-&gt;</span><span> </span><span style="color: #C18401">Thenable</span><span style="color: #A626A4">&lt;</span><span style="color: #C18401">&#039;TResult</span><span style="color: #A626A4">&gt;</span>

<span style="color: #A626A4">module</span><span style="color: #4078F2"> Thenable </span><span style="color: #A626A4">=</span>
<span>    </span><span style="color: #A0A1A7;font-style: italic">// Transform a thenable into a promise</span>
<span>    </span><span style="color: #A626A4">let</span><span> </span><span style="color: #E45649">toPromise</span><span style="color: #383A42"> </span><span style="color: #A626A4">(</span><span style="color: #383A42">t</span><span style="color: #A626A4">:</span><span> </span><span style="color: #C18401">Thenable</span><span style="color: #A626A4">&lt;</span><span style="color: #C18401">&#039;t</span><span style="color: #A626A4">&gt;):</span><span> </span><span style="color: #C18401">JS.Promise</span><span style="color: #A626A4">&lt;</span><span style="color: #C18401">&#039;t</span><span style="color: #A626A4">&gt;</span><span> </span><span style="color: #A626A4">=</span><span>  unbox t</span>

<span style="color: #A626A4">type</span><span> </span><span style="color: #C18401">Promise.PromiseBuilder</span><span> </span><span style="color: #A626A4">with</span>
<span>    </span><span style="color: #A0A1A7;font-style: italic">/// To make a value interop with the promise builder, you have to add an</span>
<span>    </span><span style="color: #A0A1A7;font-style: italic">/// overload of the `Source` member to convert from your type to a promise.</span>
<span>    </span><span style="color: #A0A1A7;font-style: italic">/// Because thenables are trivially convertible, we can just unbox them.</span>
<span>    </span><span style="color: #A626A4">member</span><span> </span><span style="color: #E45649">x.Source</span><span style="color: #A626A4">(</span><span style="color: #383A42">t</span><span style="color: #A626A4">:</span><span> </span><span style="color: #C18401">Thenable</span><span style="color: #A626A4">&lt;</span><span style="color: #C18401">&#039;t</span><span style="color: #A626A4">&gt;):</span><span> </span><span style="color: #C18401">JS.Promise</span><span style="color: #A626A4">&lt;</span><span style="color: #C18401">&#039;t</span><span style="color: #A626A4">&gt;</span><span> </span><span style="color: #A626A4">=</span><span> Thenable.toPromise t</span>

<span>    </span><span style="color: #A0A1A7;font-style: italic">// Also provide these cases for overload resolution</span>
<span>    </span><span style="color: #A626A4">member</span><span> </span><span style="color: #E45649">_.Source</span><span style="color: #A626A4">(</span><span style="color: #383A42">p</span><span style="color: #A626A4">:</span><span> </span><span style="color: #C18401">JS.Promise</span><span style="color: #A626A4">&lt;</span><span style="color: #C18401">&#039;T1</span><span style="color: #A626A4">&gt;):</span><span> </span><span style="color: #C18401">JS.Promise</span><span style="color: #A626A4">&lt;</span><span style="color: #C18401">&#039;T1</span><span style="color: #A626A4">&gt;</span><span> </span><span style="color: #A626A4">=</span><span> p</span>
<span>    </span><span style="color: #A626A4">member</span><span> </span><span style="color: #E45649">_.Source</span><span style="color: #A626A4">(</span><span style="color: #383A42">ps</span><span style="color: #A626A4">:</span><span style="color: #C18401"> </span><span>#</span><span style="color: #383A42">seq&lt;_&gt;</span><span style="color: #A626A4">):</span><span> </span><span style="color: #C18401">_ </span><span style="color: #A626A4">=</span><span> ps</span>

<span style="color: #A0A1A7;font-style: italic">// You can now works with instance of Thenable from the promise computation</span>

<span style="color: #A0A1A7;font-style: italic">// Dummy thenable for the example</span>
<span style="color: #A626A4">let</span><span> </span><span style="color: #E45649">sampleThenable</span><span style="color: #383A42"> </span><span style="color: #986801">()</span><span> </span><span style="color: #A626A4">=</span>
<span>    </span><span style="color: #A626A4">promise {</span>
<span>        </span><span style="color: #A626A4">return</span><span> </span><span style="color: #986801">1</span>
<span>    </span><span style="color: #A626A4">}</span>
<span>    </span><span style="color: #A626A4">|&gt;</span><span> Thenable.ofPromise</span>

<span style="color: #A0A1A7;font-style: italic">// See how you can use the thenable directly from the promise computation</span>
<span style="color: #A626A4">promise {</span>
<span>    </span><span style="color: #A626A4">let!</span><span> </span><span style="color: #E45649">initialValue</span><span> </span><span style="color: #A626A4">=</span><span> sampleThenable</span><span style="color: #986801">()</span>
<span>    </span><span style="color: #A0A1A7;font-style: italic">// ...</span>
<span style="color: #A626A4">}</span></code></pre>
</div></div></section><div class="navigation-container"><a class="button navigate-to-previous is-primary is-outlined" href="/fable-promise/documentation/pipeline.html"><span class="icon"><i class=" fas fa-arrow-left"></i></span><span class=" is-uppercase">Pipeline</span></a><button class="button navigate-to-next is-invisible"></button></div></div></div></div><script async="" src="/fable-promise/resources/nacara-standard-layouts/scripts/menu.js"></script></body></html>